procedure
parm dgrow type=int default=20

parm path type=string default="re_data/"
parm rootpre type=string  default="2009-11-10T070802_RE4_1B-NAC_2570700_71771_"
parm rootpost type=string default="2009-11-18T071752_RE2_1B-NAC_2572546_71771_"
parm outtabroot type=string default="outtabroot"

local pre20sig real
local post20sig real
local pre30sig real
local post30sig real

local pre10sig real
local post10sig real
local pre40sig real
local post40sig real

local pre50sig real
local post50sig real
local pre60sig real
local post60sig real

local prebgsig real
local postbgsig real
local prendvisig real
local postndvisig real
local metafilepre string
local cloudmaskpre string
local metafilepost string
local cloudmaskpost string
local totalmask string

local bigmaskpre string
local bigmaskpost string

local cloudmask string
local lnstr string
local qexist integer

local outibis string
local outimg string

refgbl $echo
refgbl $autousage
refgbl $syschar
body
let $autousage = "none"
let _onfail="return"
let $echo="yes"

write "detre1 03/09/2010"
let outibis = "&outtabroot" // ".asc"
let outimg = "&outtabroot" // ".img"

let metafilepre = "&path" // "&rootpre" // "MTL.txt"
let cloudmaskpre = "&rootpre" // "cloud.img"
let lnstr = "&path" // "&rootpre" // "band1_cut.img"
ush ln -fs &lnstr pre10r
let lnstr = "&path" // "&rootpre" // "band2_cut.img"
ush ln -fs &lnstr pre20r
let lnstr = "&path" // "&rootpre" // "band3_cut.img"
ush ln -fs &lnstr pre30r
let lnstr = "&path" // "&rootpre" // "band4_cut.img"
ush ln -fs &lnstr pre40r
let lnstr = "&path" // "&rootpre" // "band5_cut.img"
ush ln -fs &lnstr pre50r

let metafilepost = "&path" // "&rootpost" // "MTL.txt"
let cloudmaskpost = "&rootpost" // "cloud.img"
let cloudmask = "&rootpost" // "cmbcloud.img"
let lnstr = "&path" // "&rootpost" // "band1_cut.img"
ush ln -fs &lnstr post10r
let lnstr = "&path" // "&rootpost" // "band2_cut.img"
ush ln -fs &lnstr post20r
let lnstr = "&path" // "&rootpost" // "band3_cut.img"
ush ln -fs &lnstr post30r
let lnstr = "&path" // "&rootpost" // "band4_cut.img"
ush ln -fs &lnstr post40r
let lnstr = "&path" // "&rootpost" // "band5_cut.img"
ush ln -fs &lnstr post50r
  
let bigmaskpre = "&rootpre" // "lsatpre.img"
let bigmaskpost = "&rootpost" // "lsatpost.img"
let totalmask = "&rootpost" // "totalmask.img"

ush ln -fs pre10r pre10
ush ln -fs pre20r pre20
ush ln -fs pre30r pre30
ush ln -fs pre40r pre40
ush ln -fs pre50r pre50
ush ln -fs post10r post10
ush ln -fs post20r post20
ush ln -fs post30r post30
ush ln -fs post40r post40
ush ln -fs post50r post50

!!!!!!!!goto curr        !keep this switch for analysis

! cloudmask then reflectance

!acca (pre20r,pre30r,pre40r,pre50r,pre60) +
!  meta=&metafilepre out=&cloudmaskpre
!xvd &cloudmaskpre

!acca (post20r,post30r,post40r,post50r,post60) +
!  meta=&metafilepost out=&cloudmaskpost
!xvd &cloudmaskpost

!f2 inp=(&cloudmaskpre,&cloudmaskpost) out=&cloudmask +
!   fun="max(in1,in2)"
!xvd &cloudmask

!multilsatref inp=(pre10r,pre20r,pre30r,pre40r,pre50r) +
!   out=(pre10,pre20,pre30,pre40,pre50) +
!   meta=&metafilepre

!multilsatref inp=(post10r,post20r,post30r,post40r,post50r) +
!   out=(post10,post20,post30,post40,post50) +
!   meta=&metafilepost

!hist pre20 'exclude sigma=pre20sig mode=nohist
!hist post20 'exclude sigma=post20sig mode=nohist
!hist pre30 'exclude sigma=pre30sig mode=nohist
!hist post30 'exclude sigma=post30sig mode=nohist

!hist pre10 'exclude sigma=pre10sig mode=nohist
!hist post10 'exclude sigma=post10sig mode=nohist
!hist pre40 'exclude sigma=pre40sig mode=nohist
!hist post40 'exclude sigma=post40sig mode=nohist

!hist pre50 'exclude sigma=pre50sig mode=nohist
!hist post50 'exclude sigma=post50sig mode=nohist
!hist pre60 'exclude sigma=pre60sig mode=nohist
!hist post60 'exclude sigma=post60sig mode=nohist

cvdnorm (pre10,pre20,pre30,pre40,pre50, +
   post10,post20,post30,post40,post50) +
   out=(nxpre1,nxpre2,nxpre3,nxpre4,nxpre5, +
   nxpost1,nxpost2,nxpost3,nxpost4,nxpost5) +
   sigma=(1.0,1.0,1.0,1.0,1.0, +
   1.0,1.0,1.0,1.0,1.0) +
   printls=(5863,4093) window=11 donut=5 

!  sigma=(&pre10sig,&pre20sig,&pre30sig,&pre40sig,&pre50sig,&pre60sig, +
!  &post10sig,&post20sig,&post30sig,&post40sig,&post50sig,&post60sig) +

!  bg and nvdi

f2 (nxpre5,nxpre3) out=nxbgpre fun="((in1-in2)/(in1+in2))*200+128"
f2 (nxpost5,nxpost3) out=nxbgpost fun="((in1-in2)/(in1+in2))*200+128"
f2 (nxpre4,nxpre3) out=nxndvipre fun="((in1-in2)/(in1+in2))*200+128"
f2 (nxpost4,nxpost3) out=nxndvipost fun="((in1-in2)/(in1+in2))*200+128"

!hist nxbgpre 'exclude sigma=prebgsig mode=nohist
!hist nxbgpost 'exclude sigma=postbgsig mode=nohist
!hist nxndvipre 'exclude sigma=prendvisig mode=nohist
!hist nxndvipost 'exclude sigma=postndvisig mode=nohist

cvdnorm (nxbgpre,nxndvipre,nxbgpost,nxndvipost) +
   out=(nxbgprenorm,nxndviprenorm,nxbgpostnorm,nxndvipostnorm) +
   sigma=(1.0,1.0,1.0,1.0) +
   printls=(5863,4093) window=11 donut=5 'nopre

!  sigma=(&prebgsig,&prendvisig,&postbgsig,&postndvisig) +

f2 (nxbgprenorm,nxbgpostnorm) out=nxdifbg fun="(in2-in1)*0.004+128" format=byte
f2 (nxndviprenorm,nxndvipostnorm) out=nxdifndvi fun="(in2-in1)*0.5+128" format=byte

! brightness diff

f2 (nxpre1,nxpost1) out=nxdif1 fun="(in2-in1)*0.008+128" format=byte
f2 (nxpre2,nxpost2) out=nxdif2 fun="(in2-in1)*0.008+128" format=byte
f2 (nxpre3,nxpost3) out=nxdif3 fun="(in2-in1)*0.008+128" format=byte
f2 (nxpre4,nxpost4) out=nxdif4 fun="(in2-in1)*0.006+128" format=byte
f2 (nxpre5,nxpost5) out=nxdif5 fun="(in2-in1)*0.008+128" format=byte

! compute totalmask

f2 (pre10,pre20,pre30,pre40,pre50) out=&bigmaskpre format=byte +
  fun="(in1.gt.0.5)*(in2.gt.0.5)*(in3.gt.0.5)*(in4.gt.0.5)*(in5.gt.0.5)"
f2 (post10,post20,post30,post40,post50) out=&bigmaskpost format=byte +
  fun="(in1.gt.0.5)*(in2.gt.0.5)*(in3.gt.0.5)*(in4.gt.0.5)*(in5.gt.0.5)"

!f2 &cloudmask out=xxxicloud2 fun="1-in1" format=byte
!moore xxxicloud2 xxxicloud dmax=5 'outone
!f2 (&cloudmask,xxxicloud) out=xxxcloud2 fun="(in2.lt.0.5)*in1" format=byte
!moore xxxcloud2 xxxcloud dmax=50 'outone
f2 (&bigmaskpre,&bigmaskpost) out=&totalmask format=byte +
     fun="(in1.gt.0.5)*(in2.gt.0.5)"

! do target 1 in xxxim4a

f2 (nxdif1,nxdif2,nxdif3,nxdif4) out=xxxim3a format=byte +
  fun="(in1+in2+in3+in4-512)*0.25+128"
f2 nxdifbg out=xxxim3b fun="128-(in1-128)" format=byte
f2 nxdifndvi out=xxxim3n fun="128+(in1-128)" format=byte


!!!!!!!!curr>


f2 (xxxim3a,xxxim3b,xxxim3n,&totalmask) out=xxxim4a +
   fun="(in1.gt.154)*(in2.gt.126)*(in3.gt.126)*(in4.gt.0.5)"

goto theend

! do target 2 in xxxim4b

moore xxxim4a xxxim4g dmax=&dgrow

f2 (nxdif1,nxdif2,nxdif3,nxdif4,nxdif5) out=xxxim3 format=byte +
  fun="(in1.lt.128)*(in2.lt.128)*(in3.lt.128)*(in4.lt.128)*(in5.lt.128)* +
  (in1+in2+in3+in4-512)*0.125+128"
f2 (xxxim3,xxxim3b,xxxim3n,xxxim4g) out=xxxim4b +
   fun="(in1.lt.121)*(in2.lt.129)*(in3.lt.101)*(in4.gt.0.5)* +
   (in3.lt.(in2-25))*2"

f2 (xxxim4a,xxxim4b,&totalmask) xxxim4 +
     fun="(in1+in2*(in1.lt.0.5))*(in3.gt.0.5)"

! connected component

cform xxxim4 xxxim5 oform=full

concomp xxxim5 (xxxim6, xxxim6work)

!xvd xxxim6

comptab inp=(xxxim6, xxxim5) out=xxxltab.ibis

getzval (xxxim4, xxxltab.ibis) cols=(3,4,11) 'NOIN

rowop2 xxxltab.ibis outtab keycol=2 range=(0, 6) 'select

compject (xxxim6, outtab) out=&outimg cols=(1,11)

pixmap (outtab, &outimg) mapcols=(9,10) pixcol=(3,4) 'pixtomap

ibis-l outtab cols=(1,9,10,11) 'noheader 'nocol +
   outfile=&outibis cfor="%7d %15.8f %14.8f %7.0f"

theend>
end-proc
