procedure
parm inp type=(string,99)

local watermask type=(string,99)
local afidsvdevdata type=(string,99)
local temp1 type=(string,99)
local temp2 type=(string,99)
local temp3 type=(string,99)
local fmt string
body

! utility to display image vs. water mask

translog AFIDS_VDEV_DATA afidsvdevdata
let watermask = "&afidsvdevdata/world_30as_lwm.img"

let temp1 = "&inp" // ".rev1"
let temp2 = "&inp" // ".rev2"
let temp3 = "&inp" // ".rev3"

lab2tcl &inp v1=fmt keyword=format 'system
if (fmt="BYTE")
   gtcopy &inp +
     &temp1
else
   f2 &inp +
     &temp1 +
     fun="in1*0.022" format=byte
end-if

stretch inp=&temp1 +
  out=&temp2 +
  'gauss

gtwarp &watermask +
  &temp1 +
  ref=&temp2 +
  'coverref  nah=400 nav=400

f2 &temp1 +
  &temp3 +
  fun="in1*128"
 
xvd (&temp3, +
    &temp2, +
    &temp2)

! cleanup doesn't work, xvd asynch

end-proc
