procedure help=*
parm gridfile type=string
parm image1 type=string
parm image2 type=string
parm gridout type=string
parm fcorfail type=string
parm seq type=string default="qq"

parm search int default=128
parm fftsize int default=128
parm ffthalf int default=0 valid=(0:2)
parm minsrch int default=128

parm lsqt type=real
parm locfit type=string default="" valid=("","locfit")

parm lsqthresh type=int
parm zrej type=int default=255
parm zerolim type=real default=10.0
parm zerolim2 type=real default=10.0
parm seed int default=0
parm magnif type=real default=1.0
parm magmin type=real default=1.0
parm magshrk type=(string,2) valid=("y","n") default="n"
parm thr_res type=real default=10.0
parm redo int default=40

local corfail int
local xxxxlsq1 string
local xxxxlsq2 string
local gridoutlen type=int

body

write "piclsqqd 10 dec 08"

let _onfail="return"

let corfail = 1
let xxxxlsq1 = "xxxxlsq1" // "&seq"
let xxxxlsq2 = "xxxxlsq2" // "&seq"

mf3 &gridfile f=("c9=c1$c10=c2$@avg(c9)$@avg(c10)$c8=@rand$", +
 "c11=(@abs(c9-c1)+@abs(c10-c2)+1000)*c8*c8") seed=&seed
sort &gridfile sortcol=11

picmtch5 (&image1,&image2,&gridfile) SEARCH=&search fftsize=&fftsize +
       minsrch=&minsrch zrej=&zrej pred=linear autofit=18 redo=&redo +
       zerolim=&zerolim zerolim2=&zerolim2 ffthalf=&ffthalf thr_res=&thr_res +
       magnif=(&magnif,&magnif) magmin=(&magmin,&magmin) magshrk=&magshrk
ibis-l &gridfile cols=(5,8,9,10,11) nr=8

!  lsq quadratic approach for eliminating bad match points.
!  need more columns
ibis-gen   xxxxlsq1 version="ibis-2" org=column nc=18 nr=1 deffmt=DOUB
ibis-copy  &gridfile xxxxlsq1 nc=18

!  remove -9999 points from file (failed matches)
rowop2      xxxxlsq1 xxxxlsq2 keycol=10 range=(-10000.0,-9000.0) 'delete 
mf3        xxxxlsq2 func="c12=1.0$c16=c1*c1$c17=c1*c2$c18=c2*c2"

if (locfit="")
   ibislsq3 inp=xxxxlsq2 out=&gridout indcol=(1,2,12,16,17,18) +
      depcol=6 depcol2=7 rescol=13 rescol2=14 'noprint thresh=&lsqt
else
   ibislsq9 inp=xxxxlsq2 out=&gridout indcol=(1,2,12,16,17,18) +
      depcol=(6,7) rescol=(13,14) 'noprint thresh=&lsqt
end-if

mf3       xxxxlsq2 func="c15=@sqrt(c13*c13+c14*c14)"
ibis-list  &gridout cols=(1,2,6,7,9,10,11,13,14,15) nr=2

pixmap (&gridout,&image2) mapcol=(3,4) pixcol=(6,7) 'pixtomap

ibis2tcl &gridout vclen=gridoutlen vartype=1
if (gridoutlen>lsqthresh) let corfail = 0
write "gridoutlen lsqthresh corfail &gridoutlen &lsqthresh &corfail"
save-variable file=&fcorfail variable=(corfail)

end-proc
.TITLE
piclsqqd - picmtch5 and apply lsq to remove bad matches
.HELP
PURPOSE
     
	   
CALL

sample code from avwarp.pdf:



gengrid out=&xxe ncol=11 nah=5 nav=4 hbase=400.0 hsize = 700.0 +
                                    vbase=170.0 vsize = 240.0


piclsqqd &xxe &xxxB3out1 avmaster &xxf &xxxcorfail &seq +
  search=128  fftsize=128 minsrch=128 lsqt=5.0 lsqthresh=16
restore-variable file=&xxxcorfail variable=(corfail)
write "Acorfail &corfail"
if (corfail=0) goto cordone

piclsqqd &xxe &xxxB3out1 avmaster2 &xxf &xxxcorfail &seq +
  search=128  fftsize=128 minsrch=128 lsqt=5.0 lsqthresh=10
restore-variable file=&xxxcorfail variable=(corfail)
write "Bcorfail &corfail"
if (corfail=0) goto cordone

write "none of the correlations worked, clock step"
ibis-l corrnotwork

cordone>

OPERATION


PERFORMANCE

Restrictions
------------


Original Programmer: A. L. Zobrist, 21 Jan, 2002
Current Cognizant Programmer: A. L. Zobrist
Last change by: A. L. Zobrist, 11 Dec, 2007

.LEVEL1

.END
